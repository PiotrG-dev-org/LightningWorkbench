general:
  branches:
    ignore:
      - /feature\/.*/
machine:
  python:
    version: 2.7.12
  environment:
    CUMULUSCI_KEYCHAIN_CLASS: cumulusci.core.keychain.EnvironmentProjectKeychain
    DX_URL: https://developer.salesforce.com/media/salesforce-cli/sfdx-v5.7.6-d42cf65-linux-amd64.tar.xz
dependencies:
  override:
    - pip install --upgrade pip
    #- pip install --upgrade cumulusci
    - git clone git@github.com:Szandor72/CumulusCI
    - cd CumulusCI; git checkout master; pip install -e .
    - if [[ $CIRCLE_BRANCH != "master" ]]; then wget -qO- $DX_URL | tar xJf -; fi 
    - if [[ $CIRCLE_BRANCH != "master" ]]; then sudo ./sfdx/install; fi 
    - if [[ $CIRCLE_BRANCH != "master" ]]; then sudo chmod 777 /home/ubuntu/.cache/sfdx -R; fi 
    - if [[ $CIRCLE_BRANCH != "master" ]]; then sudo sfdx plugins:install salesforcedx@pre-release; fi 
    - if [[ $CIRCLE_BRANCH != "master" ]]; then sudo sfdx update; fi 
    - if [[ $CIRCLE_BRANCH != "master" ]]; then sudo chmod 777 /home/ubuntu/.sfdx/ -R; fi 
    - if [[ $CIRCLE_BRANCH != "master" ]]; then mkdir tmp; fi 
    - if [[ $CIRCLE_BRANCH != "master" ]]; then echo $SSL_SERVER_KEY_HEX | xxd -r -ps >> tmp/server.key; fi 
    - if [[ $CIRCLE_BRANCH != "master" ]]; then openssl rsa -in tmp/server.key -check -noout; fi 
    - if [[ $CIRCLE_BRANCH != "master" ]]; then sfdx force:auth:jwt:grant --clientid $DX_CONSUMER_KEY --jwtkeyfile tmp/server.key --username $DX_USER --setdefaultdevhubusername; fi 
test:
  pre:
    - if [[ $CIRCLE_BRANCH == "master" ]]; then cci flow run ci_master --org packaging; fi
    - if [[ $CIRCLE_BRANCH == "master" ]]; then cci flow run release_beta --org packaging; fi
  override:
    - if [[ $CIRCLE_BRANCH == "master" ]]; then cci flow run ci_beta --org beta --delete-org; else cci flow run ci_feature --org feature --delete-org; fi
  post:
    - mkdir -p $CIRCLE_TEST_REPORTS/junit/
    - cp test_results.xml $CIRCLE_TEST_REPORTS/junit/
    - if [[ $CIRCLE_BRANCH != "master" ]]; then cp test_results.json $CIRCLE_ARTIFACTS; fi
    #- if [[ $CIRCLE_BRANCH != "master" ]]; then cci task run apextestsdb_upload; fi
